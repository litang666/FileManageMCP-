"""
server.py - íŒŒì¼ ì •ë¦¬ MCP ì„œë²„
FastMCPë¥¼ ì‚¬ìš©í•˜ì—¬ íŒŒì¼ ì •ë¦¬ ë„êµ¬ë“¤ì„ LLMì— ë…¸ì¶œí•©ë‹ˆë‹¤.

ì‹¤í–‰ ë°©ë²•:
    uv run python server.py
    ë˜ëŠ”
    python server.py
"""

from mcp.server.fastmcp import FastMCP
from typing import Optional

# ë„êµ¬ í•¨ìˆ˜ë“¤ ì„í¬íŠ¸
from tools import (
    # ì„¤ì • ë„êµ¬
    set_dry_run,
    get_dry_run_status,
    configure_workspace,
    config,
    # ë¶„ì„ ë„êµ¬
    list_directory,
    read_file_snippet,
    get_image_metadata,
    analyze_directory_structure,
    # ì•¡ì…˜ ë„êµ¬
    move_file,
    rename_file,
    create_folder,
    batch_rename_with_date,
)


# FastMCP ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
mcp = FastMCP(
    name="file-organization-agent",
    version="1.0.0",
)


# ============================================================================
# ì„¤ì • ë„êµ¬ ë“±ë¡
# ============================================================================

@mcp.tool()
def tool_set_dry_run(enabled: bool) -> str:
    """
    Dry Run ëª¨ë“œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    Dry Runì´ í™œì„±í™”ë˜ë©´ íŒŒì¼ ì‹œìŠ¤í…œì„ ì‹¤ì œë¡œ ë³€ê²½í•˜ì§€ ì•Šê³  
    ì–´ë–¤ ì‘ì—…ì´ ìˆ˜í–‰ë ì§€ë§Œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    
    Args:
        enabled: Trueë©´ Dry Run í™œì„±í™” (ì•ˆì „ ëª¨ë“œ), Falseë©´ ì‹¤ì œ ë³€ê²½ ìˆ˜í–‰
        
    Returns:
        ì„¤ì • ê²°ê³¼ ë©”ì‹œì§€
    """
    return set_dry_run(enabled)


@mcp.tool()
def tool_get_status() -> str:
    """
    í˜„ì¬ ì„¤ì • ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
    Dry Run ëª¨ë“œ ìƒíƒœì™€ ì‘ì—… ì˜ì—­ ì„¤ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
    
    Returns:
        í˜„ì¬ ì„¤ì • ìƒíƒœ ì •ë³´
    """
    from utils import get_target_root
    root = get_target_root()
    root_info = f"ì‘ì—… ì˜ì—­: {root}" if root else "ì‘ì—… ì˜ì—­: ì„¤ì •ë˜ì§€ ì•ŠìŒ (ëª¨ë“  ê²½ë¡œ ì ‘ê·¼ ê°€ëŠ¥ - ì£¼ì˜!)"
    return f"{get_dry_run_status()}\n{root_info}\nìµœëŒ€ ë””ë ‰í† ë¦¬ ê¹Šì´: {config.max_depth}"


@mcp.tool()
def tool_configure_workspace(root_path: str) -> str:
    """
    ì‘ì—… ì˜ì—­(ìƒŒë“œë°•ìŠ¤)ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    ì„¤ì • í›„ì—ëŠ” ì´ ë””ë ‰í† ë¦¬ ë‚´ì—ì„œë§Œ íŒŒì¼ ì‘ì—…ì´ í—ˆìš©ë©ë‹ˆë‹¤.
    ì‹œìŠ¤í…œ ë³´í˜¸ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ ì‘ì—… ì „ì— ì„¤ì •í•˜ì„¸ìš”.
    
    Args:
        root_path: ì‘ì—…í•  ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê²½ë¡œ (ì˜ˆ: "D:\\MyDocuments\\ToOrganize")
        
    Returns:
        ì„¤ì • ê²°ê³¼ ë©”ì‹œì§€
    """
    return configure_workspace(root_path)


# ============================================================================
# ë¶„ì„ ë„êµ¬ ë“±ë¡ (Read-Only)
# ============================================================================

@mcp.tool()
def tool_list_directory(path: str, show_hidden: bool = False) -> str:
    """
    ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ê³¼ í´ë” ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
    ê° í•­ëª©ì˜ ìƒì„±/ìˆ˜ì • ë‚ ì§œì™€ YYMMDD í˜•ì‹ íŒŒì¼ëª… ì œì•ˆë„ í•¨ê»˜ í‘œì‹œí•©ë‹ˆë‹¤.
    
    ì¡°ì§ ê·œì¹™:
    - í´ë”ëŠ” 00~99 ì ‘ë‘ì‚¬ ì‚¬ìš© (ì˜ˆ: 01_Project)
    - íŒŒì¼ì€ YYMMDD ë‚ ì§œ ì ‘ë‘ì‚¬ ì‚¬ìš© (ì˜ˆ: 251202_Report.docx)
    
    Args:
        path: íƒìƒ‰í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ
        show_hidden: ìˆ¨ê¹€ íŒŒì¼/í´ë” í‘œì‹œ ì—¬ë¶€ (ê¸°ë³¸: False)
        
    Returns:
        ë””ë ‰í† ë¦¬ ë‚´ìš© ëª©ë¡ (ë‚ ì§œ ì •ë³´ í¬í•¨)
    """
    return list_directory(path, show_hidden)


@mcp.tool()
def tool_read_file_snippet(path: str, max_length: int = 5000) -> str:
    """
    íŒŒì¼ì˜ ì‹œì‘ ë¶€ë¶„ì„ ì½ì–´ ë‚´ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.
    í…ìŠ¤íŠ¸/ì½”ë“œ íŒŒì¼ì˜ ì»¨í…ìŠ¤íŠ¸ íŒŒì•…ì— ìœ ìš©í•©ë‹ˆë‹¤.
    Windows í™˜ê²½ì˜ cp949/euc-kr ì¸ì½”ë”©ë„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    
    Args:
        path: ì½ì„ íŒŒì¼ ê²½ë¡œ
        max_length: ìµœëŒ€ ì½ì„ ê¸€ì ìˆ˜ (ê¸°ë³¸: 5000)
        
    Returns:
        íŒŒì¼ ë‚´ìš© ìŠ¤ë‹ˆí«ê³¼ ë©”íƒ€ë°ì´í„°
    """
    return read_file_snippet(path, max_length)


@mcp.tool()
def tool_get_image_metadata(path: str) -> str:
    """
    ì´ë¯¸ì§€ íŒŒì¼ì˜ EXIF ë©”íƒ€ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
    íŠ¹íˆ ì´¬ì˜ ë‚ ì§œ ì •ë³´ë¥¼ ê°€ì ¸ì™€ YYMMDD íŒŒì¼ëª…ì„ ì œì•ˆí•©ë‹ˆë‹¤.
    
    Args:
        path: ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œ (JPG, PNG ë“±)
        
    Returns:
        ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì •ë³´ ë° íŒŒì¼ëª… ì œì•ˆ
    """
    return get_image_metadata(path)


@mcp.tool()
def tool_analyze_directory_structure(path: str) -> str:
    """
    ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ê³  ì •ë¦¬ê°€ í•„ìš”í•œ ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤.
    
    ë¶„ì„ í•­ëª©:
    - íŒŒì¼/í´ë” í†µê³„
    - í™•ì¥ìë³„ ë¶„í¬
    - ëª…ëª… ê·œì¹™ ìœ„ë°˜ (í´ë” ë²ˆí˜¸ ì²´ê³„)
    - ë””ë ‰í† ë¦¬ ê¹Šì´ ì´ˆê³¼
    - ë‚ ì§œ ì ‘ë‘ì‚¬ ëˆ„ë½ íŒŒì¼
    
    Args:
        path: ë¶„ì„í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ
        
    Returns:
        êµ¬ì¡° ë¶„ì„ ê²°ê³¼ ë° ì •ë¦¬ ì œì•ˆ
    """
    return analyze_directory_structure(path)


# ============================================================================
# ì•¡ì…˜ ë„êµ¬ ë“±ë¡ (File Modification - Dry Run ì§€ì›)
# ============================================================================

@mcp.tool()
def tool_move_file(source: str, destination: str) -> str:
    """
    íŒŒì¼ì„ ë‹¤ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
    
    ì•ˆì „ ê¸°ëŠ¥:
    - Dry Run ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ì´ë™ ì—†ì´ ì‹œë®¬ë ˆì´ì…˜ë§Œ ìˆ˜í–‰
    - ì‘ì—… ì˜ì—­ ì™¸ë¶€ë¡œì˜ ì´ë™ ì°¨ë‹¨
    - ì‹œìŠ¤í…œ í´ë” ì ‘ê·¼ ì°¨ë‹¨
    
    Args:
        source: ì´ë™í•  íŒŒì¼ì˜ í˜„ì¬ ê²½ë¡œ
        destination: ì´ë™í•  ëŒ€ìƒ ê²½ë¡œ (ë””ë ‰í† ë¦¬ ë˜ëŠ” ì „ì²´ ê²½ë¡œ)
        
    Returns:
        ì‘ì—… ê²°ê³¼ ë©”ì‹œì§€ (Dry Run ì‹œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼)
    """
    return move_file(source, destination)


@mcp.tool()
def tool_rename_file(path: str, new_name: str) -> str:
    """
    íŒŒì¼ ë˜ëŠ” í´ë”ì˜ ì´ë¦„ì„ ë³€ê²½í•©ë‹ˆë‹¤.
    
    ëª…ëª… ê·œì¹™:
    - í´ë”: 'NN_ì´ë¦„' í˜•ì‹ ê¶Œì¥ (ì˜ˆ: 01_Project, 99_Archive)
    - íŒŒì¼: 'YYMMDD_íŒŒì¼ëª…' í˜•ì‹ ê¶Œì¥ (ì˜ˆ: 251202_Report.docx)
    
    ì•ˆì „ ê¸°ëŠ¥:
    - Dry Run ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ë³€ê²½ ì—†ì´ ì‹œë®¬ë ˆì´ì…˜ë§Œ ìˆ˜í–‰
    - ëª…ëª… ê·œì¹™ ìœ„ë°˜ ì‹œ ê²½ê³  í‘œì‹œ
    
    Args:
        path: ì´ë¦„ì„ ë³€ê²½í•  íŒŒì¼/í´ë” ê²½ë¡œ
        new_name: ìƒˆ ì´ë¦„ (ê²½ë¡œ ì œì™¸, ì´ë¦„ë§Œ)
        
    Returns:
        ì‘ì—… ê²°ê³¼ ë©”ì‹œì§€ (Dry Run ì‹œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼)
    """
    return rename_file(path, new_name)


@mcp.tool()
def tool_create_folder(path: str, name: Optional[str] = None) -> str:
    """
    ìƒˆ í´ë”ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    ëª…ëª… ê·œì¹™:
    - 'NN_ì´ë¦„' í˜•ì‹ ê¶Œì¥ (ì˜ˆ: 01_Business, 02_Project)
    - 99_ArchiveëŠ” ë³´ê´€ìš©ìœ¼ë¡œ ì˜ˆì•½
    
    ì œí•œ ì‚¬í•­:
    - ìµœëŒ€ ë””ë ‰í† ë¦¬ ê¹Šì´: 5ë‹¨ê³„
    - Dry Run ëª¨ë“œì—ì„œëŠ” ì‹¤ì œ ìƒì„± ì—†ì´ ì‹œë®¬ë ˆì´ì…˜ë§Œ ìˆ˜í–‰
    
    Args:
        path: í´ë”ë¥¼ ìƒì„±í•  ìœ„ì¹˜ ë˜ëŠ” ì „ì²´ í´ë” ê²½ë¡œ
        name: í´ë” ì´ë¦„ (ì„ íƒì , pathì— í¬í•¨ëœ ê²½ìš° ìƒëµ)
        
    Returns:
        ì‘ì—… ê²°ê³¼ ë©”ì‹œì§€ (Dry Run ì‹œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼)
    """
    return create_folder(path, name)


@mcp.tool()
def tool_batch_rename_with_date(directory: str, use_modified: bool = True) -> str:
    """
    ë””ë ‰í† ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ì— YYMMDD ë‚ ì§œ ì ‘ë‘ì‚¬ë¥¼ ì¼ê´„ ì¶”ê°€í•©ë‹ˆë‹¤.
    ì´ë¯¸ ë‚ ì§œ ì ‘ë‘ì‚¬ê°€ ìˆëŠ” íŒŒì¼ì€ ê±´ë„ˆëœë‹ˆë‹¤.
    
    ì˜ˆì‹œ:
    - report.docx â†’ 251202_report.docx (ìˆ˜ì •ì¼ ê¸°ì¤€)
    - photo.jpg â†’ 241115_photo.jpg (ìƒì„±ì¼ ë˜ëŠ” ìˆ˜ì •ì¼ ê¸°ì¤€)
    
    Args:
        directory: ëŒ€ìƒ ë””ë ‰í† ë¦¬ ê²½ë¡œ
        use_modified: Trueë©´ ìˆ˜ì •ì¼, Falseë©´ ìƒì„±ì¼ ì‚¬ìš© (ê¸°ë³¸: True)
        
    Returns:
        ì‘ì—… ê²°ê³¼ (Dry Run ì‹œ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼)
    """
    return batch_rename_with_date(directory, use_modified)


# ============================================================================
# í”„ë¡¬í”„íŠ¸ ë¦¬ì†ŒìŠ¤ ë“±ë¡
# ============================================================================

@mcp.resource("organization://rules")
def get_organization_rules() -> str:
    """íŒŒì¼ ì •ë¦¬ ê·œì¹™ ë¬¸ì„œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    return """
# ğŸ“‚ íŒŒì¼ ì •ë¦¬ ê·œì¹™

## 2ê°€ì§€ ì ˆëŒ€ ê·œì¹™

1. **5ë‹¨ê³„ ê·œì¹™**: ë””ë ‰í† ë¦¬ ê¹Šì´ëŠ” ìµœëŒ€ 5ë‹¨ê³„ê¹Œì§€ë§Œ í—ˆìš©
2. **ë²ˆí˜¸ ì²´ê³„**: í´ë”ëŠ” 00~99 ì ‘ë‘ì‚¬ ì‚¬ìš© (ì˜ˆ: `01_Project`). 99ëŠ” Archive ìš©ë„ë¡œ ì˜ˆì•½

## ğŸ—‚ï¸ í´ë” êµ¬ì¡° ì˜ˆì‹œ

### ê°œì¸ í´ë”
- 01_Gallery (ê°¤ëŸ¬ë¦¬/ì‚¬ì§„)
- 02_Study (í•™ìŠµ ìë£Œ)  
- 03_Hobby (ì·¨ë¯¸ ê´€ë ¨)

### ì—…ë¬´ í´ë”
- 01_Business (ì‚¬ì—…/ì—…ë¬´)
- 02_Project (í”„ë¡œì íŠ¸)
- 03_Freelance (í”„ë¦¬ëœìŠ¤)

### ê³µí†µ í´ë”
- Template (í…œí”Œë¦¿ íŒŒì¼)
- Quick Share (ë¹ ë¥¸ ê³µìœ ìš© ì„ì‹œ í´ë”)

## ğŸ“ íŒŒì¼ ëª…ëª… ê·œì¹™

1. **ì‹œê°„ìˆœ ì •ë ¬ íŒŒì¼**: `YYMMDD_íŒŒì¼ëª…` (ì˜ˆ: `251202_íšŒì˜ë¡`)
   - íŒŒì¼ì˜ ìƒì„±ì¼ ë˜ëŠ” ìˆ˜ì •ì¼ì„ ê¸°ì¤€ìœ¼ë¡œ í•¨
   
2. **ì•ŒíŒŒë²³ìˆœ ì •ë ¬ íŒŒì¼**: ì°¸ì¡° ë¬¸ì„œ ë“±ì€ ì´ë¦„ìˆœ ì •ë ¬

3. **ë²„ì „ ê´€ë¦¬**: `_v1.0`, `_v2.0` í˜•ì‹ ì‚¬ìš©
   - 'Final', 'ìµœì¢…', 'ì§„ì§œìµœì¢…' ê¸ˆì§€!
   - ì˜ˆ: `251202_í”„ë¡œì íŠ¸ê³„íšì„œ_v1.0.docx`

## âš ï¸ ê¸ˆì§€ ì‚¬í•­

- ì‹œìŠ¤í…œ í´ë” ì ‘ê·¼ ê¸ˆì§€ (Windows, Program Files ë“±)
- .git í´ë” ìˆ˜ì • ê¸ˆì§€
- 5ë‹¨ê³„ ì´ìƒ ì¤‘ì²© í´ë” ìƒì„± ê¸ˆì§€
"""


@mcp.resource("organization://workflow")
def get_workflow_guide() -> str:
    """ì •ë¦¬ ì‘ì—… ì›Œí¬í”Œë¡œìš° ê°€ì´ë“œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    return """
# ğŸ”„ íŒŒì¼ ì •ë¦¬ ì›Œí¬í”Œë¡œìš°

## 1ë‹¨ê³„: ì¤€ë¹„
1. `tool_configure_workspace`ë¡œ ì‘ì—… ì˜ì—­ ì„¤ì •
2. `tool_get_status`ë¡œ Dry Run í™œì„±í™” í™•ì¸
3. `tool_analyze_directory_structure`ë¡œ í˜„í™© íŒŒì•…

## 2ë‹¨ê³„: ë¶„ì„ (Dry Run ëª¨ë“œ)
1. `tool_list_directory`ë¡œ ëŒ€ìƒ í´ë” íƒìƒ‰
2. ì •ë¦¬ê°€ í•„ìš”í•œ í•­ëª© íŒŒì•…:
   - ë²ˆí˜¸ ì—†ëŠ” í´ë”
   - ë‚ ì§œ ì—†ëŠ” íŒŒì¼
   - ê¹Šì´ ì´ˆê³¼ êµ¬ì¡°

## 3ë‹¨ê³„: ê³„íš ìˆ˜ë¦½
1. í•„ìš”í•œ í´ë” êµ¬ì¡° ì„¤ê³„ (5ë‹¨ê³„ ì´ë‚´)
2. íŒŒì¼ ì´ë™/ì´ë¦„ë³€ê²½ ê³„íš
3. `tool_move_file`, `tool_rename_file` ë¡œ Dry Run ì‹œë®¬ë ˆì´ì…˜

## 4ë‹¨ê³„: ì‹¤í–‰
1. ì‚¬ìš©ì í™•ì¸ í›„ `tool_set_dry_run(false)` ë¡œ ì‹¤ì œ ëª¨ë“œ ì „í™˜
2. ê³„íšëœ ì‘ì—… ì‹¤í–‰
3. ê²°ê³¼ í™•ì¸

## 5ë‹¨ê³„: ê²€ì¦
1. `tool_analyze_directory_structure`ë¡œ ì •ë¦¬ ê²°ê³¼ í™•ì¸
2. ë¬¸ì œ ìˆìœ¼ë©´ ì¶”ê°€ ì •ë¦¬
3. ì™„ë£Œ í›„ `tool_set_dry_run(true)`ë¡œ ì•ˆì „ ëª¨ë“œ ë³µê·€
"""


# ============================================================================
# ì„œë²„ ì‹œì‘
# ============================================================================

if __name__ == "__main__":
    print("ğŸš€ íŒŒì¼ ì •ë¦¬ MCP ì„œë²„ ì‹œì‘...")
    print("   ì„œë²„ëª…: file-organization-agent")
    print("   ë²„ì „: 1.0.0")
    print("")
    print("ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬:")
    print("   [ì„¤ì •] tool_set_dry_run, tool_get_status, tool_configure_workspace")
    print("   [ë¶„ì„] tool_list_directory, tool_read_file_snippet, tool_get_image_metadata")
    print("   [ë¶„ì„] tool_analyze_directory_structure")
    print("   [ì•¡ì…˜] tool_move_file, tool_rename_file, tool_create_folder")
    print("   [ì•¡ì…˜] tool_batch_rename_with_date")
    print("")
    print("âš ï¸  ê¸°ë³¸ì ìœ¼ë¡œ Dry Run ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.")
    print("   ì‹¤ì œ íŒŒì¼ ë³€ê²½ì„ ìœ„í•´ì„œëŠ” tool_set_dry_run(false)ë¥¼ í˜¸ì¶œí•˜ì„¸ìš”.")
    print("")
    
    # stdio ì „ì†¡ ë°©ì‹ìœ¼ë¡œ ì„œë²„ ì‹¤í–‰
    mcp.run()

